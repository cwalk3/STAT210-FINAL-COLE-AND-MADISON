---
title: "sta210 project"
author: "Cole Walker, Madison Griffin"
format: pdf
editor: visual
---

## loading packages & dataset
```{r message = F}
library(tidyverse)
library(tidymodels)
library(readxl)
library(MASS)
library(leaps)
library(caret)
library(glmnet)
library(Stat2Data)
#library(statnnet)
library(lme4)
library(UpSetR)
library(nlme)
library(sjstats)
set.seed(8)
soccer <- read_excel("AllTimeRankingByClub.xlsx")
```

#### Introduction and data

## Data Cleaning
```{r}
soccer = soccer %>%
  rename(goals_for = `Goals For`,
         goals_against = `Goals Against`,
         goal_diff = `Goal Diff`)

soccer = soccer %>%
  mutate(winspermatch = Win/Played,
         pointspermatch = Pts/Played,
         goalspermatch = goals_for/Played,
         goalsagainstpermatch = goals_against/Played,
         goalmarginpermatch = goal_diff/Played)

soccer = soccer %>%
  mutate(topfiveleague = ifelse(Country == 'ESP' | Country == 'ENG' | Country == 'GER' | Country == 'ITA' | Country == 'FRA', "top five", "not top five"))
```

## EDA

Plot 1: 
```{r}
soccer %>%
  filter(Titles > 0) %>%
  ggplot(aes(x = reorder(Club, (-Titles)), y = Titles)) +
  geom_bar(stat = 'identity') +
  labs(x = 'Club', y = 'Number of Titles', title = 'Number of Titles for each Club',
       subtitle = 'Excluding Clubs That Have Never Won a Title') +
  theme_bw() +
  scale_x_discrete(guide = guide_axis(angle = 45))
```

Plot 2:
```{r}
soccer %>%
  filter(Titles > 0) %>%
  ggplot(aes(x = reorder(Country, (-Titles)), y = Titles)) +
  geom_bar(stat = 'identity') +
  labs(x = 'Country', y = 'Number of Titles', title = 'Number of Titles per Country',
       subtitle = 'Excluding Clubs That Have Never Won a Title') +
  theme_bw() +
  scale_x_discrete(guide = guide_axis(angle = 45))
```

Plot 3:
```{r warnings = F}
ggplot(data = soccer, aes(x = winspermatch, y = goalmarginpermatch)) +
  geom_point() +
  geom_smooth(method = 'lm', se = F, color = 'midnightblue') +
  labs(x = "Win Percentage", y = 'Goal Margin per Match', 
       title = 'Club Win Percentage in Tournament vs. Goal Margin Per Match') +
  theme_bw()
```

#### Methods
Model 1: Linear Regression

Outcome:

- points per match

Predictors:

- wins per match

- goals per match

- goals against per match

- goal margin per match

- top five league

```{r}
model1 = lm(pointspermatch ~ winspermatch + goalspermatch + 
               goalsagainstpermatch + goalmarginpermatch + topfiveleague, 
               data = soccer)
summary(model1)
```

Conditions for Model 1:
Violated linearity, constant variance, and normality
```{r}
model1aug = augment(model1)

ggplot(model1aug, aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, color = 'maroon') +
  labs(x = "Fitted (predicted) values", y = 'Residual') +
  ggtitle('Residual Plot Violates Linearity & Constant Variance Assumptions') +
  theme_bw()

ggplot(model1aug, aes(sample = .resid)) +
  stat_qq() +
  stat_qq_line() +
  theme_bw() +
  labs(x = 'Theoretical quantiles',
       y = 'Sample quantiles',
       title = 'QQ Plot Violates Normality Assumption')
```

testing correlations because something is weird

```{r}
test = soccer %>%
  dplyr::select(pointspermatch, winspermatch, goalspermatch, goalsagainstpermatch, goalmarginpermatch)

cor(test)
```
Model 2: Linear Regression

Outcome:

- points per match

Predictors:

- wins per match

- goals per match

- goals against per match

- top five league

```{r}
model2 = lm(pointspermatch ~ winspermatch + goalspermatch + 
               goalsagainstpermatch + topfiveleague, 
               data = soccer)
summary(model2)
```
Check Assumptions for Model 2
still all violated

```{r}
model2aug = augment(model2)

ggplot(model2aug, aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, color = 'maroon') +
  labs(x = "Fitted (predicted) values", y = 'Residual') +
  ggtitle('Residual Plot Violates Linearity & Constant Variance Assumptions') +
  theme_bw()

ggplot(model2aug, aes(sample = .resid)) +
  stat_qq() +
  stat_qq_line() +
  theme_bw() +
  labs(x = 'Theoretical quantiles',
       y = 'Sample quantiles',
       title = 'QQ Plot Violates Normality Assumption')
```

Model 3: Linear Regression

Outcome:

- points per match

Predictors:

- wins per match

- goal margin per match

- top five league

```{r}
model3 = lm(pointspermatch ~ winspermatch + goalmarginpermatch + topfiveleague, 
            data = soccer)
summary(model3)
```
Check Assumptions Model 3

```{r}
model3aug = augment(model3)

ggplot(model3aug, aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, color = 'maroon') +
  labs(x = "Fitted (predicted) values", y = 'Residual') +
  ggtitle('Residual Plot Violates Linearity & Constant Variance Assumptions') +
  theme_bw()

ggplot(model3aug, aes(sample = .resid)) +
  stat_qq() +
  stat_qq_line() +
  theme_bw() +
  labs(x = 'Theoretical quantiles',
       y = 'Sample quantiles',
       title = 'QQ Plot Violates Normality Assumption')
```

Model 4: Linear Mixed Effects Model (potential violation of independence with topfiveleague)

Outcome:

- points per match

Predictors:

- random intercept for topfiveleague

- goal margin per match

- wins per match

- goals per match

```{r}
model4 = lmer(pointspermatch ~ 1 + goalspermatch + winspermatch + goalsagainstpermatch +
              (1|topfiveleague), data = soccer)
summary(model4)
```

Checking assumptions model 4

```{r}
plot(model4)
hist((resid(model4) - mean(resid(model4))) / sd(resid(model4)), freq = FALSE); curve(dnorm, add = TRUE)
```

Model 5: Linear Regression

Outcome:

- points per match

Predictors:

- topfiveleague

- goal margin per match

- goals per match

- goals against per match

```{r}
model5 = lm(pointspermatch ~ goalspermatch + goalsagainstpermatch + goalmarginpermatch +
            topfiveleague, data = soccer)
summary(model5)
```

Checking Assumptions

```{r}
model5aug = augment(model5)

ggplot(model5aug, aes(x = .fitted, y = .resid)) +
  geom_point() +
  geom_hline(yintercept = 0, color = 'maroon') +
  labs(x = "Fitted (predicted) values", y = 'Residual') +
  ggtitle('Residual Plot Violates Linearity & Constant Variance Assumptions') +
  theme_bw()

ggplot(model5aug, aes(sample = .resid)) +
  stat_qq() +
  stat_qq_line() +
  theme_bw() +
  labs(x = 'Theoretical quantiles',
       y = 'Sample quantiles',
       title = 'QQ Plot Violates Normality Assumption')
```

Model 6: linear mixed effects (random intercept for topfiveleague)

Outcome:

- points per match

Predictors:

- random intercept for topfiveleague

- goal margin per match

- goals per match

```{r}
model6 = lmer(pointspermatch ~ 1 + goalspermatch + goalsagainstpermatch + goalmarginpermatch +
              (1|topfiveleague), data = soccer)
summary(model6)
```

Checking assumptions:

```{r}
plot(model6)
hist((resid(model6) - mean(resid(model6))) / sd(resid(model6)), freq = FALSE); curve(dnorm, add = TRUE)
```


## Variable Selection - LASSO

```{r}
y = soccer$pointspermatch
x = model.matrix(pointspermatch ~ winspermatch + goalspermatch + goalsagainstpermatch +
                 goalmarginpermatch + topfiveleague, data = soccer)
m_lasso_cv = cv.glmnet(x, y, alpha = 1)

best_lambda = m_lasso_cv$lambda.min
best_lambda

m_best = glmnet(x, y, alpha = 1, lambda = best_lambda)
m_best$beta

bestlasso = lm(pointspermatch ~ winspermatch + goalmarginpermatch + topfiveleague,
               data = soccer)
```

## Variable Selection - Stepwise Selection

```{r}
m_none = lm(pointspermatch ~ 1, data = soccer)
m_all = lm(pointspermatch ~ winspermatch + goalspermatch + goalsagainstpermatch +
                 goalmarginpermatch + topfiveleague, data = soccer)
```

**Forward Selection**

```{r}
stepAIC(m_none,
        scope = list(lower = m_none, upper = m_all),
        data = soccer, direction = 'forward')
bestforward = lm(pointspermatch ~ winspermatch + goalmarginpermatch + 
    topfiveleague, data = soccer)
```

**Backward Selection**

```{r}
stepAIC(m_all,
        scope = list(lower = m_none, upper = m_all),
        data = soccer, direction = 'backward')
bestbackward = lm(pointspermatch ~ winspermatch + goalspermatch + goalsagainstpermatch +
                    topfiveleague, data = soccer)
```

**Both Selection**

```{r}
stepAIC(m_none,
        scope = list(lower = m_none, upper = m_all),
        data = soccer, direction = 'both')
bestboth = lm(pointspermatch ~ winspermatch + goalmarginpermatch + topfiveleague, data = soccer)
```

## Variable Selection - Mallo's CP

```{r}
soccer_allsub = regsubsets(pointspermatch ~ winspermatch + goalspermatch + 
                           goalsagainstpermatch + goalmarginpermatch + topfiveleague,
                           data = soccer,
                           nbest = 1, nvmax = 5)
soccer_allsub 
summary(soccer_allsub)$rsq
summary(soccer_allsub)$which
bestallsubset = lm(pointspermatch ~ winspermatch, data = soccer)
```


## Comparing RMSE after variable selection

RMSE All Subset: 0.1642128

**RMSE Best Backward: 0.1348656 - LOWEST**

RMSE Best Both, Forward, Lasso: 0.1348667

(they had the same predictors in it)

CONCLUSION:

- best backward has lowest rmse so better

- predictors: wins per match, top five league, goals per match, goals against per match

```{r}
rmse(bestallsubset)
rmse(bestbackward)
rmse(bestboth)
rmse(bestforward)
rmse(bestlasso)
```


##possibly delete -- Comparing Models: RMSE

RMSE Model 1: 0.1348656
RMSE Model 2: 0.1348656
RMSE Model 3: 0.1348667
RMSE Model 4: 0.1349185

```{r}
rmse(model1)
rmse(model2)
rmse(model3)
rmse(model4)
```

#### Results

#### Conclusion





















